<?php
require "config.php";

// Security: Direct access prohibited without prior upload
if (!isset($_SESSION['current_image_id'])) {
    header("Location: upload.php");
    exit;
}

$imgId = $_SESSION['current_image_id'];

// Recovery of the 3 variants generated by Java
// We sort by ID to be sure that the order is always Bicubic -> Bilinear -> Nearest
$stmt = $db->prepare("SELECT * FROM mosaic_proposals WHERE image_id = ? AND strategy LIKE 'PREVIEW_%' ORDER BY id ASC");
$stmt->execute([$imgId]);
$proposals = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Processing the 'ORDER' Click
if (isset($_POST['choose_render']) && isset($_POST['proposal_id']) && isset($_POST['algo_target'])) {
    $selectedPropId = intval($_POST['proposal_id']);
    $algoId = intval($_POST['algo_target']); 
    $newStrategy = "ALGO_" . $algoId;
    $upd = $db->prepare("UPDATE mosaic_proposals SET strategy = ?, total_bricks_count = 0 WHERE id = ?");
    $upd->execute([$newStrategy, $selectedPropId]);
    $_SESSION['final_proposal_id'] = $selectedPropId;
    header("Location: cart.php"); 
    exit;
}
?>

<?php include "header.php"; ?>

<div class="results-container">

    <div class="results-header">
        <h2><?= msg('results_title') ?></h2>
        <p><?= msg('results_subtitle') ?></p>
    </div>

    <div class="results-grid">

        <?php if (empty($proposals)): ?>
            <div class="loading-card">
                <div class="spinner"></div>
                <h3><?= msg('generating_variants_title') ?></h3>
                <p><?= msg('generating_variants_desc') ?></p>
                <script>setTimeout(() => window.location.reload(), 3000);</script>
            </div>
        <?php else: ?>

            <?php foreach ($proposals as $p): ?>
                <?php
                $rawStyle = str_replace('PREVIEW_', '', $p['strategy']);
                $imgFile = "uploads/preview_" . $p['id'] . ".png";
                $isReady = file_exists($imgFile);

                // Variables for the grid
                $imgWidth = 32; // Security default value
                $imgHeight = 32;

                if ($isReady) {
                    // we retrieve the true size of the table
                    list($w, $h) = getimagesize($imgFile);
                    $imgWidth = $w;
                    $imgHeight = $h;
                }

                $title = ""; $desc = ""; $algoTarget = 5;

                if ($rawStyle === 'BICUBIC') {
                    $title = msg('style_title_bicubic');
                    $desc = msg('style_desc_bicubic');
                    $algoTarget = 3;
                } elseif ($rawStyle === 'BILINEAR') {
                    $title = msg('style_title_bilinear');
                    $desc = msg('style_desc_bilinear');
                    $algoTarget = 4;
                } elseif ($rawStyle === 'NEAREST') {
                    $title = msg('style_title_nearest');
                    $desc = msg('style_desc_nearest');
                    $algoTarget = 5;
                }
                ?>

                <div class="card result-card">
                    <div class="card-header">
                        <h3><?= $title ?></h3>
                    </div>

                    <div class="card-image-box">
                        <?php if ($isReady): ?>
                            <img src="render_lego.php?id=<?= $p['id'] ?>&t=<?= time() ?>" 
                                 alt="<?= $title ?>"
                                 class="preview-img">
                        <?php else: ?>
                            <div class="spinner-box">
                                <div class="spinner"></div>
                                <small><?= msg('card_loading_text') ?></small>
                            </div>
                            <script>setTimeout(() => window.location.reload(), 2000);</script>
                        <?php endif; ?>
                    </div>

                    <div class="card-body">
                        <p class="card-desc">
                            <?= $desc ?>
                        </p>
                        <?php if ($isReady): ?>
                            <form method="post">
                                <input type="hidden" name="proposal_id" value="<?= $p['id'] ?>">
                                <input type="hidden" name="algo_target" value="<?= $algoTarget ?>">
                                <button type="submit" name="choose_render" class="btn-primary">
                                    <?= msg('btn_choose_style') ?>
                                </button>
                            </form>
                        <?php else: ?>
                            <button disabled class="btn-disabled">...</button>
                        <?php endif; ?>
                    </div>
                </div>
            <?php endforeach; ?>

        <?php endif; ?>
    </div>
</div>

<?php include "footer.php"; ?>

<style>
    .results-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
    }

    .results-header {
        text-align: center;
        margin-bottom: 40px;
    }
    .results-header h2 { color: var(--text); margin-bottom: 10px; font-size: 2rem; }
    .results-header p { color: #64748b; }

    .results-grid {
        display: grid;
        /* on PC: We force 3 strict columns */
        grid-template-columns: 1fr 1fr 1fr; 
        gap: 30px;
    }

    .result-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border: 1px solid #e2e8f0;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .result-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.1);
        border-color: var(--accent);
    }

    .card-header {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #f1f5f9;
        background: #f8fafc;
    }
    .card-header h3 { margin: 0; color: var(--accent); font-size: 1.2rem; }

    .card-image-box {
        background: #0f172a;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 300px; 
    }

    .preview-img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
        image-rendering: pixelated; 
    }

    .card-body {
        padding: 20px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }

    .card-desc {
        text-align: center;
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 20px;
    }

    /* Buttons */
    .btn-primary {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: opacity 0.2s;
    }
    .btn-primary:hover { opacity: 0.9; }
    .btn-disabled { width: 100%; padding: 12px; background: #cbd5e1; border: none; border-radius: 8px; cursor: not-allowed; color: white; }

    /* Loading States */
    .loading-card {
        grid-column: 1 / -1; 
        text-align: center;
        padding: 60px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .spinner { width: 30px; height: 30px; border: 3px solid rgba(255, 255, 255, 0.2); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin: 0 auto; }
    .loading-card .spinner { border-color: #e2e8f0; border-top-color: var(--accent); margin-bottom: 20px; }
    .spinner-box { text-align: center; color: white; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Responsive (Mobile & Tablette < 900px) */
    @media (max-width: 900px) {
        .results-grid {
            /* MOBILE: We force only 1 column */
            grid-template-columns: 1fr; 
            gap: 20px;
        }

        .card-image-box {
            height: 250px;
        }
    }
</style>